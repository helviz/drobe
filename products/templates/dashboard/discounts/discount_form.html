{% extends "base.html" %}
{% load widget_tweaks %}


{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">
                <i class="fas fa-percent me-2"></i>
                {% if object %}Edit{% else %}Add{% endif %} Discount
            </h3>
        </div>

        <div class="card-body p-4">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- Display form errors -->
                {% if form.non_field_errors %}
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        {{ form.non_field_errors }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endif %}

                <!-- Basic Information Section -->
                <div class="mb-4">
                    <h5 class="text-primary border-bottom pb-2 mb-3">
                        <i class="fas fa-info-circle me-2"></i>Basic Information
                    </h5>

                    <div class="row g-3">
                        <!-- Name -->
                        <div class="col-md-6">
                            <label for="{{ form.name.id_for_label }}" class="form-label fw-semibold">
                                <i class="fas fa-tag me-1"></i>Discount Name
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-signature"></i></span>
                                {{ form.name }}
                            </div>
                            {% if form.name.errors %}
                                <div class="text-danger small mt-1">{{ form.name.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Discount Type -->
                        <div class="col-md-3">
                            <label for="{{ form.discount_type.id_for_label }}" class="form-label fw-semibold">
                                <i class="fas fa-list-alt me-1"></i>Discount Type
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-percentage"></i></span>
                                {{ form.discount_type }}
                            </div>
                            {% if form.discount_type.errors %}
                                <div class="text-danger small mt-1">{{ form.discount_type.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Value -->
                        <div class="col-md-3">
                            <label for="{{ form.value.id_for_label }}" class="form-label fw-semibold">
                                <i class="fas fa-dollar-sign me-1"></i>Value
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-calculator"></i></span>
                                {{ form.value }}
                            </div>
                            {% if form.value.errors %}
                                <div class="text-danger small mt-1">{{ form.value.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Priority -->
                        <div class="col-md-6">
                            <label for="{{ form.priority.id_for_label }}" class="form-label fw-semibold">
                                <i class="fas fa-sort-numeric-down me-1"></i>Priority
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-star"></i></span>
                                {{ form.priority }}
                            </div>
                            <div class="form-text">Higher numbers = higher priority</div>
                            {% if form.priority.errors %}
                                <div class="text-danger small mt-1">{{ form.priority.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Active -->
                        <div class="col-md-6 d-flex align-items-center">
                            <div class="form-check form-switch mt-4">
                                {{ form.active }}
                                <label class="form-check-label fw-semibold" for="{{ form.active.id_for_label }}">
                                    <i class="fas fa-toggle-on me-1"></i>Active Status
                                </label>
                                {% if form.active.errors %}
                                    <div class="text-danger small">{{ form.active.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Date Range Section -->
                <div class="mb-4">
                    <h5 class="text-primary border-bottom pb-2 mb-3">
                        <i class="fas fa-calendar-alt me-2"></i>Date Range
                    </h5>

                    <div class="row g-3">
                        <!-- Start Date -->
                        <div class="col-md-6">
                            <label for="{{ form.start_date.id_for_label }}" class="form-label fw-semibold">
                                <i class="fas fa-calendar-plus me-1"></i>Start Date
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                {{ form.start_date }}
                            </div>
                            {% if form.start_date.errors %}
                                <div class="text-danger small mt-1">{{ form.start_date.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- End Date -->
                        <div class="col-md-6">
                            <label for="{{ form.end_date.id_for_label }}" class="form-label fw-semibold">
                                <i class="fas fa-calendar-minus me-1"></i>End Date
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                {{ form.end_date }}
                            </div>
                            {% if form.end_date.errors %}
                                <div class="text-danger small mt-1">{{ form.end_date.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Target Selection Section -->
                <div class="mb-4">
                    <h5 class="text-primary border-bottom pb-2 mb-3">
                        <i class="fas fa-bullseye me-2"></i>Discount Targets
                    </h5>

                    <!-- Selection Type Buttons -->
                    <div class="mb-3">
                        <div class="btn-group" role="group" aria-label="Discount target selection">
                            <input type="radio" class="btn-check" name="target_type" id="target_all" checked>
                            <label class="btn btn-outline-primary" for="target_all">
                                <i class="fas fa-globe me-1"></i>All Products
                            </label>

                            <input type="radio" class="btn-check" name="target_type" id="target_categories">
                            <label class="btn btn-outline-primary" for="target_categories">
                                <i class="fas fa-folder me-1"></i>By Categories
                            </label>

                            <input type="radio" class="btn-check" name="target_type" id="target_products">
                            <label class="btn btn-outline-primary" for="target_products">
                                <i class="fas fa-box me-1"></i>By Products
                            </label>

                            <input type="radio" class="btn-check" name="target_type" id="target_brands">
                            <label class="btn btn-outline-primary" for="target_brands">
                                <i class="fas fa-award me-1"></i>By Brands
                            </label>
                        </div>
                        <div class="form-text">Choose how to apply this discount</div>
                    </div>

                    <!-- Target Selection Areas -->
                    <div class="row g-3">
                        <!-- Categories Section -->
                        <div class="col-12" id="categories_section" style="display: none;">
                            <div class="card border-primary">
                                <div class="card-header bg-primary bg-opacity-10">
                                    <h6 class="mb-0">
                                        <i class="fas fa-folder me-2"></i>Select Categories
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                        {{ form.categories }}
                                    </div>
                                    {% if form.categories.errors %}
                                        <div class="text-danger small mt-2">{{ form.categories.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Products Section -->
                        <div class="col-12" id="products_section" style="display: none;">
                            <div class="card border-success">
                                <div class="card-header bg-success bg-opacity-10">
                                    <h6 class="mb-0">
                                        <i class="fas fa-box me-2"></i>Select Products
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <input type="text" class="form-control" id="product_search" placeholder="Search products...">
                                    </div>
                                    <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                        {{ form.products }}
                                    </div>
                                    {% if form.products.errors %}
                                        <div class="text-danger small mt-2">{{ form.products.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Brands Section -->
                        <div class="col-12" id="brands_section" style="display: none;">
                            <div class="card border-warning">
                                <div class="card-header bg-warning bg-opacity-10">
                                    <h6 class="mb-0">
                                        <i class="fas fa-award me-2"></i>Select Brands
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <input type="text" class="form-control" id="brand_search" placeholder="Search brands...">
                                    </div>
                                    <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                        {{ form.brands }}
                                    </div>
                                    {% if form.brands.errors %}
                                        <div class="text-danger small mt-2">{{ form.brands.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Buttons -->
                <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                    <a href="{% url 'discount-list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Cancel
                    </a>
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>
                        {% if object %}Update{% else %}Add{% endif %} Discount
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .form-control, .form-select {
        border: 1px solid #ced4da;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .form-control:focus, .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    .input-group-text {
        background-color: #f8f9fa;
        border: 1px solid #ced4da;
    }

    .btn-check:checked + .btn-outline-primary {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: white;
    }

    .card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    .border-bottom {
        border-bottom: 2px solid #dee2e6 !important;
    }

    /* Custom checkbox/radio styling */
    input[type="checkbox"], input[type="radio"] {
        margin-right: 0.5rem;
    }

    /* Search input styling */
    #product_search, #brand_search {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }

    /* Selection areas */
    .card-header {
        font-weight: 600;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get all radio buttons and sections
    const targetAll = document.getElementById('target_all');
    const targetCategories = document.getElementById('target_categories');
    const targetProducts = document.getElementById('target_products');
    const targetBrands = document.getElementById('target_brands');

    const categoriesSection = document.getElementById('categories_section');
    const productsSection = document.getElementById('products_section');
    const brandsSection = document.getElementById('brands_section');

    // Function to show/hide sections based on selection
    function toggleSections() {
        // Hide all sections first
        categoriesSection.style.display = 'none';
        productsSection.style.display = 'none';
        brandsSection.style.display = 'none';

        // Clear selections when switching
        if (!targetCategories.checked) {
            const categoryInputs = categoriesSection.querySelectorAll('input[type="checkbox"]');
            categoryInputs.forEach(input => input.checked = false);
        }

        if (!targetProducts.checked) {
            const productInputs = productsSection.querySelectorAll('input[type="checkbox"]');
            productInputs.forEach(input => input.checked = false);
        }

        if (!targetBrands.checked) {
            const brandInputs = brandsSection.querySelectorAll('input[type="checkbox"]');
            brandInputs.forEach(input => input.checked = false);
        }

        // Show selected section
        if (targetCategories.checked) {
            categoriesSection.style.display = 'block';
        } else if (targetProducts.checked) {
            productsSection.style.display = 'block';
        } else if (targetBrands.checked) {
            brandsSection.style.display = 'block';
        }
    }

    // Add event listeners
    targetAll.addEventListener('change', toggleSections);
    targetCategories.addEventListener('change', toggleSections);
    targetProducts.addEventListener('change', toggleSections);
    targetBrands.addEventListener('change', toggleSections);

    // Search functionality for products
    const productSearch = document.getElementById('product_search');
    if (productSearch) {
        productSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const productLabels = productsSection.querySelectorAll('label');

            productLabels.forEach(label => {
                const text = label.textContent.toLowerCase();
                const listItem = label.closest('li') || label.parentElement;
                if (text.includes(searchTerm)) {
                    listItem.style.display = '';
                } else {
                    listItem.style.display = 'none';
                }
            });
        });
    }

    // Search functionality for brands
    const brandSearch = document.getElementById('brand_search');
    if (brandSearch) {
        brandSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const brandLabels = brandsSection.querySelectorAll('label');

            brandLabels.forEach(label => {
                const text = label.textContent.toLowerCase();
                const listItem = label.closest('li') || label.parentElement;
                if (text.includes(searchTerm)) {
                    listItem.style.display = '';
                } else {
                    listItem.style.display = 'none';
                }
            });
        });
    }

    // Form validation before submit
    document.querySelector('form').addEventListener('submit', function(e) {
        const discountName = document.querySelector('[name="name"]').value.trim();
        const discountValue = document.querySelector('[name="value"]').value.trim();

        if (!discountName) {
            e.preventDefault();
            alert('Please enter a discount name.');
            return;
        }

        if (!discountValue) {
            e.preventDefault();
            alert('Please enter a discount value.');
            return;
        }

        // Check if a specific target is selected but no items are chosen
        if (targetCategories.checked) {
            const categoryChecked = categoriesSection.querySelector('input[type="checkbox"]:checked');
            if (!categoryChecked) {
                e.preventDefault();
                alert('Please select at least one category.');
                return;
            }
        }

        if (targetProducts.checked) {
            const productChecked = productsSection.querySelector('input[type="checkbox"]:checked');
            if (!productChecked) {
                e.preventDefault();
                alert('Please select at least one product.');
                return;
            }
        }

        if (targetBrands.checked) {
            const brandChecked = brandsSection.querySelector('input[type="checkbox"]:checked');
            if (!brandChecked) {
                e.preventDefault();
                alert('Please select at least one brand.');
                return;
            }
        }
    });
});
</script>
{% endblock %}